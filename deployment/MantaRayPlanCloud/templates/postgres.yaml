{{- $postgresSecrets := (lookup "v1" "Secret" .Values.namespace .Values.database.name ) -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.database.secret.name }}
  namespace: {{ .Values.namespace }}
type: kubernetes.io/basic-auth
data:
  username: {{ "app" | b64enc }}
{{- if and $postgresSecrets $postgresSecrets.data }}
  {{- if $postgresSecrets.data.password }}
  password: {{ $postgresSecrets.data.password }}
  {{- else }}
  password: {{ "nonExistingKey1234" | b64enc }}
  {{- end }}
{{- else }}
  password: {{ "nonExistingKey1234" | b64enc }}
{{- end }}
---
apiVersion: hostpathprovisioner.kubevirt.io/v1beta1
kind: HostPathProvisioner
metadata:
  name: hostpath-provisioner
  namespace: hostpath-provisioner
spec:
  imagePullPolicy: Always
  storagePools:
    - name: "postgres-pool"
      pvcTemplate:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: {{ .Values.database.size.combined }}
      path: "/MantaRayPlan/Postgres"
  workload:
    nodeSelector:
      kubernetes.io/os: linux
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: postgres-csi
  namespace: hostpath-provisioner
provisioner: kubevirt.io.hostpath-provisioner
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
parameters:
  storagePool: postgres-pool
---
{{- if .Values.database.enabled }}
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ .Values.database.name }}
  namespace: {{ .Values.namespace }}
spec:
  instances: 3
  primaryUpdateStrategy: unsupervised
  bootstrap:
    initdb:
      database: {{ .Values.database.dbName }}
      owner: app
      secret: 
        name: postgres-secret
  storage:
    size: {{ .Values.database.size.single }}
    pvcTemplate:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: {{ .Values.database.size.single }}
      storageClassName: postgres-csi
{{ end }}